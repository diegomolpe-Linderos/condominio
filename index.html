<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Control de Acceso - Alto Sacramento 3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f0f4f8;min-height:100vh;display:flex;flex-direction:column;}
input,select,button{font-family:inherit;}
input:disabled{background:#f9fafb;color:#6b7280;}
.hidden{display:none!important;}
#loginScreen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#0f2554 0%,#1a3a7a 100%);}
.loginCard{background:#fff;border-radius:20px;padding:40px 36px;width:330px;box-shadow:0 8px 40px rgba(0,0,0,0.25);}
.loginLogo{text-align:center;margin-bottom:20px;}
.loginLogo .icon{font-size:48px;}
.loginLogo h1{font-size:18px;font-weight:800;color:#0f2554;margin-top:8px;}
.loginLogo h2{font-size:13px;font-weight:500;color:#6b7280;margin-top:2px;}
.loginHint{font-size:12px;color:#9ca3af;text-align:center;margin-top:14px;}
.loginBrand{margin-top:28px;text-align:center;font-size:11px;color:rgba(255,255,255,0.5);}
.loginBrand span{color:rgba(255,255,255,0.8);font-weight:600;}
#header{background:linear-gradient(90deg,#0f2554 0%,#1a3a7a 100%);color:#fff;padding:0 20px;}
.headerTop{display:flex;justify-content:space-between;align-items:center;padding:12px 0 8px;}
.headerTitle{font-size:11px;font-weight:600;opacity:0.7;letter-spacing:1px;text-transform:uppercase;}
.headerName{font-size:19px;font-weight:800;}
.headerSub{font-size:12px;opacity:0.75;margin-top:2px;}
#logoutBtn{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 14px;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;}
#tabs{display:flex;background:#0f2554;}
.tab{flex:1;padding:11px 0;border:none;background:transparent;font-weight:600;font-size:12px;cursor:pointer;color:rgba(255,255,255,0.55);border-bottom:3px solid transparent;}
.tab.active{color:#fff;border-bottom:3px solid #60a5fa;}
#content{padding:16px;max-width:600px;margin:0 auto;width:100%;flex:1;}
.section{display:none;}
.section.active{display:block;}
h3{color:#0f2554;margin:8px 0 16px;font-size:17px;font-weight:700;}
.card{background:#fff;border-radius:14px;padding:18px;margin-bottom:16px;box-shadow:0 2px 8px rgba(15,37,84,0.08);}
.field{margin-bottom:14px;}
.field label{display:block;font-size:13px;font-weight:600;color:#1e293b;margin-bottom:4px;}
.req{color:#e02424;}
.field input,.field select{width:100%;padding:10px 12px;border:1px solid #dde3f0;border-radius:9px;font-size:15px;outline:none;color:#111827;background:#fff;}
.field input:focus,.field select:focus{border-color:#0f2554;}
.field input:disabled{background:#f9fafb;color:#6b7280;}
.field input.ok-border{border-color:#057a55;}
.row{display:flex;gap:12px;}
.row .field{flex:1;}
.check-label{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;font-weight:600;color:#1e293b;}
.check-label input[type=checkbox]{width:18px;height:18px;cursor:pointer;accent-color:#0f2554;}
.btn{padding:10px 20px;border-radius:9px;font-weight:700;font-size:15px;cursor:pointer;border:none;}
.btn-primary{background:#0f2554;color:#fff;width:100%;margin-top:4px;}
.btn-primary:hover{background:#1a3a7a;}
.btn-primary:disabled{background:#94a3b8;cursor:not-allowed;}
.alert-ok{background:#d1fae5;border:1px solid #057a55;border-radius:8px;padding:12px;margin-bottom:16px;color:#057a55;font-weight:600;display:none;}
.alert-ok.show{display:block;}
.alert-err{color:#e02424;font-size:13px;margin-bottom:10px;display:none;}
.alert-err.show{display:block;}
.found-msg{color:#057a55;font-size:12px;margin-top:4px;display:none;}
.found-msg.show{display:block;}
.history-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.filter-row{display:flex;gap:10px;margin-bottom:16px;}
.filter-row input{flex:1;padding:10px 12px;border:1px solid #dde3f0;border-radius:9px;font-size:14px;outline:none;}
.filter-row input[type=date]{color:#374151;}
.clear-btn{padding:10px 14px;border-radius:9px;border:1px solid #dde3f0;background:#fff;color:#6b7280;font-size:13px;cursor:pointer;}
.export-btn{padding:10px 16px;border-radius:9px;border:none;background:#057a55;color:#fff;font-weight:700;font-size:13px;cursor:pointer;}
.export-btn:hover{background:#046c4e;}
.log-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(15,37,84,0.07);border-left:4px solid #0f2554;}
.log-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.log-name{font-weight:700;font-size:16px;color:#111827;}
.log-info{font-size:13px;color:#6b7280;line-height:1.9;}
.badge{border-radius:20px;padding:2px 10px;font-size:12px;font-weight:600;}
.badge-visita{background:#dbeafe;color:#1a56db;border:1px solid #93c5fd;}
.badge-delivery{background:#fef3c7;color:#d97706;border:1px solid #fcd34d;}
.badge-encomienda{background:#d1fae5;color:#057a55;border:1px solid #6ee7b7;}
.badge-otros{background:#ede9fe;color:#7c3aed;border:1px solid #c4b5fd;}
.empty{color:#6b7280;text-align:center;padding:30px 0;font-size:14px;}
.loading{text-align:center;padding:30px 0;color:#6b7280;font-size:14px;}
.stats-row{display:flex;gap:8px;margin-bottom:16px;}
.stat-pill{flex:1;background:#fff;border-radius:10px;padding:10px 8px;text-align:center;box-shadow:0 2px 6px rgba(15,37,84,0.07);}
.stat-pill .snum{font-size:22px;font-weight:800;color:#0f2554;}
.stat-pill .slbl{font-size:10px;color:#6b7280;margin-top:2px;}
.guard-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(15,37,84,0.07);}
.guard-top{display:flex;justify-content:space-between;align-items:center;}
.guard-name{font-weight:700;font-size:16px;color:#111827;}
.guard-shift{font-size:13px;color:#6b7280;}
.guard-count .num{font-size:28px;font-weight:800;color:#0f2554;text-align:right;}
.guard-count .lbl{font-size:11px;color:#6b7280;text-align:right;}
.guard-logs{margin-top:10px;border-top:1px solid #f0f4f8;padding-top:10px;}
.guard-log-item{font-size:13px;color:#6b7280;margin-bottom:4px;}
.more{font-size:12px;color:#0f2554;font-weight:600;}
#footer{background:#0f2554;color:rgba(255,255,255,0.5);text-align:center;padding:12px 20px;font-size:11px;}
#footer span{color:rgba(255,255,255,0.85);font-weight:700;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="loginCard">
    <div class="loginLogo">
      <div class="icon">ğŸ¢</div>
      <h1>Alto Sacramento 3</h1>
      <h2>Sistema de Control de Acceso</h2>
    </div>
    <div class="field"><label>Usuario</label><input id="loginUser" placeholder="ej: carlos"/></div>
    <div class="field"><label>ContraseÃ±a</label><input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢"/></div>
    <div id="loginErr" class="alert-err"></div>
    <button class="btn btn-primary" id="loginBtn">Ingresar</button>
    <p class="loginHint">Usuarios: carlos / pedro / luis Â· pass: 1234</p>
  </div>
  <div class="loginBrand">Desarrollado por <span>Linderos Digital</span></div>
</div>

<!-- APP -->
<div id="appScreen" style="display:none;flex-direction:column;min-height:100vh;">
  <div id="header">
    <div class="headerTop">
      <div>
        <div class="headerTitle">Control de Acceso</div>
        <div class="headerName">Alto Sacramento 3</div>
        <div class="headerSub" id="guardInfo"></div>
      </div>
      <button id="logoutBtn">Salir</button>
    </div>
  </div>
  <div id="tabs">
    <button class="tab active" id="tabRegister">â• Registrar</button>
    <button class="tab" id="tabHistory">ğŸ“‹ Historial</button>
    <button class="tab" id="tabGuards">ğŸ‘® Guardias</button>
  </div>
  <div id="content">

    <!-- REGISTER -->
    <div id="registerSection" class="section active">
      <h3>Registrar Ingreso</h3>
      <div id="regOk" class="alert-ok">âœ… Visita registrada exitosamente</div>
      <div class="card">
        <div class="field">
          <label>RUT <span class="req">*</span></label>
          <input id="fRut" placeholder="ej: 12345678-9"/>
          <div id="rutFound" class="found-msg">âœ… Visita encontrada en base de datos</div>
        </div>
        <div class="row">
          <div class="field"><label>Nombre <span class="req">*</span></label><input id="fFirst" placeholder="ej: Ana"/></div>
          <div class="field"><label>Apellido <span class="req">*</span></label><input id="fLast" placeholder="ej: GarcÃ­a"/></div>
        </div>
        <div class="field">
          <label>Tipo de visita <span class="req">*</span></label>
          <select id="fType">
            <option value="">-- Seleccionar --</option>
            <option>Visita</option>
            <option>Delivery</option>
            <option>Encomienda</option>
            <option>Otros</option>
          </select>
        </div>
        <div class="field"><label>Casa NÂ° <span class="req">*</span></label><input id="fUnit" placeholder="ej: 15"/></div>
        <div class="field">
          <label class="check-label">
            <input type="checkbox" id="fVehicle"/>
            Â¿Ingresa en vehÃ­culo?
          </label>
        </div>
        <div class="field hidden" id="plateField">
          <label>Patente del vehÃ­culo <span class="req">*</span></label>
          <input id="fPlate" placeholder="ej: AB-1234"/>
        </div>
        <div class="field">
          <label>ObservaciÃ³n</label>
          <input id="fObs" placeholder="ej: Autorizado por propietario (opcional)"/>
        </div>
        <div id="regErr" class="alert-err"></div>
        <button class="btn btn-primary" id="submitBtn">âœ… Registrar Ingreso</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="historySection" class="section">
      <div class="history-top">
        <h3 style="margin:0">Historial de Accesos</h3>
        <button class="export-btn" id="exportBtn">ğŸ“Š Exportar Excel</button>
      </div>
      <div class="stats-row" id="statsRow"></div>
      <div class="filter-row">
        <input id="searchInput" placeholder="ğŸ” Nombre, RUT, casa, patente..."/>
        <input type="date" id="dateFilter"/>
        <button class="clear-btn" id="clearBtn">âœ•</button>
      </div>
      <div id="logList"></div>
    </div>

    <!-- GUARDS -->
    <div id="guardsSection" class="section">
      <h3>Panel de Guardias</h3>
      <div id="guardList"></div>
    </div>

  </div>
  <div id="footer">
    Desarrollado por <span>Linderos Digital</span> &nbsp;Â·&nbsp; Alto Sacramento 3 &copy; 2026
  </div>
</div>

<script>
(function(){
  // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var SB_URL = "https://yksfifqdwzntybcnfafq.supabase.co";
  var SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrc2ZpZnFkd3pudHliY25mYWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjQ1NTQsImV4cCI6MjA4NzA0MDU1NH0.NBuDK94ZrWrE9v3ers6iSwdD12eiIUbgOGs_Exxxv5w";
  var H = {"apikey":SB_KEY,"Authorization":"Bearer "+SB_KEY,"Content-Type":"application/json","Prefer":"return=representation"};

  function sbGet(t,q){ return axios.get(SB_URL+"/rest/v1/"+t+(q||""),{headers:H}); }
  function sbPost(t,d){ return axios.post(SB_URL+"/rest/v1/"+t,d,{headers:H}); }

  // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var guard = null;
  var allLogs = [];

  // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmtDate(d){ if(!d) return ""; var p=d.split("-"); return p[2]+"-"+p[1]+"-"+p[0]; }
  function fmtTime(t){ return t ? t.slice(0,5) : ""; }
  function formatRut(v){ var c=v.replace(/[^0-9kK]/g,"").toUpperCase(); if(c.length<=1) return c; return c.slice(0,-1)+"-"+c.slice(-1); }
  function typeClass(t){ return t==="Visita"?"badge-visita":t==="Delivery"?"badge-delivery":t==="Encomienda"?"badge-encomienda":"badge-otros"; }
  function typeBorder(t){ return t==="Visita"?"#1a56db":t==="Delivery"?"#d97706":t==="Encomienda"?"#057a55":"#7c3aed"; }
  function el(id){ return document.getElementById(id); }

  // â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function doLogin(){
    var u = el("loginUser").value.trim();
    var p = el("loginPass").value.trim();
    var btn = el("loginBtn");
    var errEl = el("loginErr");
    if(!u||!p){ errEl.textContent="Ingresa usuario y contraseÃ±a."; errEl.classList.add("show"); return; }
    btn.textContent="Verificando..."; btn.disabled=true;
    sbGet("guardias","?username=eq."+u+"&password=eq."+p+"&activo=eq.true&select=*")
      .then(function(res){
        if(res.data.length===0){
          errEl.textContent="Usuario o contraseÃ±a incorrectos."; errEl.classList.add("show");
        } else {
          errEl.classList.remove("show");
          guard = res.data[0];
          el("loginScreen").classList.add("hidden");
          el("appScreen").style.display="flex";
          el("guardInfo").textContent="ğŸ‘® "+guard.nombre+" Â· Turno "+guard.turno;
          clearForm();
        }
      })
      .catch(function(){ errEl.textContent="Error de conexiÃ³n."; errEl.classList.add("show"); })
      .finally(function(){ btn.textContent="Ingresar"; btn.disabled=false; });
  }

  function doLogout(){
    guard=null; allLogs=[];
    el("loginScreen").classList.remove("hidden");
    el("appScreen").style.display="none";
    el("loginUser").value=""; el("loginPass").value="";
    showSection("register");
    document.querySelectorAll(".tab").forEach(function(t){ t.classList.remove("active"); });
    el("tabRegister").classList.add("active");
  }

  // â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showSection(name){
    document.querySelectorAll(".section").forEach(function(s){ s.classList.remove("active"); });
    el(name+"Section").classList.add("active");
    if(name==="history") loadLogs();
    if(name==="guards") loadGuards();
  }

  // â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleRut(){
    var input = el("fRut");
    var rut = formatRut(input.value);
    input.value = rut;
    var msg = el("rutFound");
    var fFirst = el("fFirst"); var fLast = el("fLast");
    if(rut.length<4){ fFirst.disabled=false; fLast.disabled=false; input.classList.remove("ok-border"); msg.classList.remove("show"); return; }
    sbGet("visitantes","?rut=eq."+encodeURIComponent(rut)+"&select=*")
      .then(function(res){
        if(res.data.length>0){
          fFirst.value=res.data[0].nombre; fFirst.disabled=true;
          fLast.value=res.data[0].apellido; fLast.disabled=true;
          input.classList.add("ok-border"); msg.classList.add("show");
        } else {
          fFirst.disabled=false; fLast.disabled=false;
          input.classList.remove("ok-border"); msg.classList.remove("show");
        }
      }).catch(function(){});
  }

  function toggleVehicle(){
    var checked = el("fVehicle").checked;
    if(checked) el("plateField").classList.remove("hidden");
    else { el("plateField").classList.add("hidden"); el("fPlate").value=""; }
  }

  function clearForm(){
    ["fRut","fFirst","fLast","fUnit","fPlate","fObs"].forEach(function(id){ el(id).value=""; });
    el("fType").value="";
    el("fVehicle").checked=false;
    el("fFirst").disabled=false; el("fLast").disabled=false;
    el("plateField").classList.add("hidden");
    el("fRut").classList.remove("ok-border");
    el("rutFound").classList.remove("show");
    el("regErr").textContent=""; el("regErr").classList.remove("show");
  }

  function submitRegister(){
    var rut   = el("fRut").value.trim();
    var first = el("fFirst").value.trim();
    var last  = el("fLast").value.trim();
    var type  = el("fType").value;
    var unit  = el("fUnit").value.trim();
    var veh   = el("fVehicle").checked;
    var plate = el("fPlate").value.trim();
    var obs   = el("fObs").value.trim();
    var errEl = el("regErr");
    var btn   = el("submitBtn");

    var err="";
    if(!rut||!first||!last) err="Nombre, apellido y RUT son obligatorios.";
    else if(!type) err="Selecciona el tipo de visita.";
    else if(!unit) err="Ingresa el nÃºmero de casa.";
    else if(veh&&!plate) err="La patente es obligatoria si ingresa en vehÃ­culo.";
    if(err){ errEl.textContent="âš ï¸ "+err; errEl.classList.add("show"); return; }
    errEl.classList.remove("show");

    btn.textContent="Guardando..."; btn.disabled=true;

    var d = new Date();
    var fecha = d.toISOString().slice(0,10);
    var hora  = d.toTimeString().slice(0,5);

    sbGet("visitantes","?rut=eq."+encodeURIComponent(rut)+"&select=id")
      .then(function(vRes){
        var p = vRes.data.length===0 ? sbPost("visitantes",{rut:rut,nombre:first,apellido:last}) : Promise.resolve();
        return p;
      })
      .then(function(){
        return sbPost("accesos",{
          rut:rut, nombre:first, apellido:last, tipo:type,
          unidad:unit, vehiculo:veh, patente:plate||null,
          observacion:obs||null,
          guardia_id:guard.id, guardia_nombre:guard.nombre,
          turno:guard.turno, fecha:fecha, hora:hora
        });
      })
      .then(function(){
        clearForm();
        el("regOk").classList.add("show");
        setTimeout(function(){ el("regOk").classList.remove("show"); },3000);
      })
      .catch(function(e){
        errEl.textContent="âš ï¸ Error al guardar: "+(e.response&&e.response.data&&e.response.data.message?e.response.data.message:e.message||"intenta de nuevo");
        errEl.classList.add("show");
      })
      .finally(function(){ btn.textContent="âœ… Registrar Ingreso"; btn.disabled=false; });
  }

  // â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadLogs(){
    el("logList").innerHTML='<p class="loading">â³ Cargando registros...</p>';
    sbGet("accesos","?select=*&order=created_at.desc")
      .then(function(res){ allLogs=res.data; renderStats(); renderHistory(); })
      .catch(function(){ el("logList").innerHTML='<p class="empty">âŒ Error al cargar registros.</p>'; });
  }

  function clearFilters(){ el("searchInput").value=""; el("dateFilter").value=""; renderHistory(); }

  function getFiltered(){
    var q  = el("searchInput").value.toLowerCase();
    var df = el("dateFilter").value;
    return allLogs.filter(function(l){
      var mq = !q||[l.nombre,l.apellido,l.rut,l.unidad,l.patente||""].join(" ").toLowerCase().indexOf(q)>-1;
      var md = !df||l.fecha===df;
      return mq&&md;
    });
  }

  function renderStats(){
    var t=allLogs.length, v=allLogs.filter(function(l){return l.tipo==="Visita";}).length;
    var dl=allLogs.filter(function(l){return l.tipo!=="Visita";}).length;
    var vh=allLogs.filter(function(l){return l.vehiculo;}).length;
    el("statsRow").innerHTML=[[t,"Total"],[v,"Visitas"],[dl,"Deliveries"],[vh,"VehÃ­culos"]]
      .map(function(x){return '<div class="stat-pill"><div class="snum">'+x[0]+'</div><div class="slbl">'+x[1]+'</div></div>';}).join("");
  }

  function renderHistory(){
    var filtered = getFiltered();
    if(filtered.length===0){ el("logList").innerHTML='<p class="empty">ğŸ“­ Sin resultados</p>'; return; }
    el("logList").innerHTML=filtered.map(function(l){
      return '<div class="log-card" style="border-left-color:'+typeBorder(l.tipo)+'">'
        +'<div class="log-top"><span class="log-name">'+l.nombre+' '+l.apellido+'</span>'
        +'<span class="badge '+typeClass(l.tipo)+'">'+l.tipo+'</span></div>'
        +'<div class="log-info">'
        +'ğŸªª '+l.rut+' &nbsp;Â·&nbsp; ğŸ  Casa NÂ° '+l.unidad+'<br/>'
        +(l.vehiculo?'ğŸš— Patente: <b style="color:#111827">'+l.patente+'</b> &nbsp;Â·&nbsp; ':"")
        +'ğŸ“… '+fmtDate(l.fecha)+' '+fmtTime(l.hora)+'<br/>'
        +'ğŸ‘® '+l.guardia_nombre+' Â· Turno '+l.turno+'<br/>'
        +'ğŸ“ ObservaciÃ³n: <i style="color:#374151">'+(l.observacion||"Sin observaciÃ³n")+'</i>'
        +'</div></div>';
    }).join("");
  }

  function exportExcel(){
    var filtered = getFiltered();
    if(filtered.length===0){ alert("No hay registros para exportar."); return; }
    var data = filtered.map(function(l){
      return {
        "Fecha":       fmtDate(l.fecha),
        "Hora":        fmtTime(l.hora),
        "Nombre":      l.nombre,
        "Apellido":    l.apellido,
        "RUT":         l.rut,
        "Tipo":        l.tipo,
        "Casa NÂ°":     l.unidad,
        "VehÃ­culo":    l.vehiculo?"SÃ­":"No",
        "Patente":     l.patente||"",
        "Guardia":     l.guardia_nombre,
        "Turno":       l.turno,
        "ObservaciÃ³n": l.observacion||""
      };
    });
    var ws = XLSX.utils.json_to_sheet(data);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Accesos");
    var fecha = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, "Accesos_AltoSacramento3_"+fecha+".xlsx");
  }

  // â”€â”€ GUARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadGuards(){
    el("guardList").innerHTML='<p class="loading">â³ Cargando...</p>';
    Promise.all([
      sbGet("guardias","?select=*&activo=eq.true"),
      sbGet("accesos","?select=guardia_id,guardia_nombre,turno,nombre,apellido,unidad,fecha,hora&order=created_at.desc")
    ]).then(function(res){
      var guards=res[0].data; var logs=res[1].data;
      el("guardList").innerHTML=guards.map(function(g){
        var gl=logs.filter(function(l){return l.guardia_id===g.id;});
        var items=gl.slice(0,3).map(function(l){
          return '<div class="guard-log-item">â€¢ '+l.nombre+' '+l.apellido+' â†’ Casa '+l.unidad+' Â· '+fmtDate(l.fecha)+' '+fmtTime(l.hora)+'</div>';
        }).join("");
        var more=gl.length>3?'<div class="more">+'+(gl.length-3)+' mÃ¡s...</div>':"";
        return '<div class="guard-card"><div class="guard-top">'
          +'<div><div class="guard-name">ğŸ‘® '+g.nombre+'</div><div class="guard-shift">Turno: '+g.turno+'</div></div>'
          +'<div class="guard-count"><div class="num">'+gl.length+'</div><div class="lbl">registros</div></div>'
          +'</div>'+(gl.length>0?'<div class="guard-logs">'+items+more+'</div>':"")+'</div>';
      }).join("");
    }).catch(function(){ el("guardList").innerHTML='<p class="empty">âŒ Error al cargar.</p>'; });
  }

  // â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener("load", function(){
    el("loginBtn").addEventListener("click", doLogin);
    el("logoutBtn").addEventListener("click", doLogout);
    el("loginUser").addEventListener("keydown", function(e){ if(e.key==="Enter") doLogin(); });
    el("loginPass").addEventListener("keydown", function(e){ if(e.key==="Enter") doLogin(); });
    el("fRut").addEventListener("input", handleRut);
    el("fVehicle").addEventListener("change", toggleVehicle);
    el("fPlate").addEventListener("input", function(){ this.value=this.value.toUpperCase(); });
    el("submitBtn").addEventListener("click", submitRegister);
    el("searchInput").addEventListener("input", renderHistory);
    el("dateFilter").addEventListener("change", renderHistory);
    el("clearBtn").addEventListener("click", clearFilters);
    el("exportBtn").addEventListener("click", exportExcel);
    el("tabRegister").addEventListener("click", function(){ document.querySelectorAll(".tab").forEach(function(t){t.classList.remove("active");}); this.classList.add("active"); showSection("register"); });
    el("tabHistory").addEventListener("click",  function(){ document.querySelectorAll(".tab").forEach(function(t){t.classList.remove("active");}); this.classList.add("active"); showSection("history"); });
    el("tabGuards").addEventListener("click",   function(){ document.querySelectorAll(".tab").forEach(function(t){t.classList.remove("active");}); this.classList.add("active"); showSection("guards"); });
  });

})();
</script>
</body>
</html>
