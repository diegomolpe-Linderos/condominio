<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Acceso - Alto Sacramento 3</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; min-height: 100vh; }

  /* LOGIN */
  #loginScreen, #adminLoginScreen {
    min-height: 100vh;
    background: linear-gradient(135deg, #0f2554 0%, #1a3a7a 100%);
    display: flex; align-items: center; justify-content: center;
  }
  .login-box {
    background: white; border-radius: 16px; padding: 40px 32px;
    width: 100%; max-width: 360px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    text-align: center;
  }
  .login-logo { font-size: 48px; margin-bottom: 12px; }
  .login-title { color: #0f2554; font-size: 22px; font-weight: 700; margin-bottom: 4px; }
  .login-sub { color: #6b7280; font-size: 13px; margin-bottom: 28px; }
  .login-box input {
    width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb;
    border-radius: 8px; font-size: 15px; margin-bottom: 12px; outline: none;
    transition: border-color 0.2s;
  }
  .login-box input:focus { border-color: #0f2554; }
  .btn-login {
    width: 100%; padding: 13px; background: #0f2554; color: white;
    border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
    cursor: pointer; margin-bottom: 12px;
  }
  .btn-login:hover { background: #1a3a7a; }
  .btn-admin-link {
    background: none; border: none; color: #6b7280; font-size: 13px;
    cursor: pointer; text-decoration: underline; margin-top: 8px;
  }
  .login-footer { color: #9ca3af; font-size: 11px; margin-top: 24px; }
  .login-error { color: #ef4444; font-size: 13px; margin-bottom: 10px; display: none; }

  /* APP PRINCIPAL */
  #appScreen { display: none; min-height: 100vh; flex-direction: column; }
  .app-header {
    background: #0f2554; color: white; padding: 14px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .app-header-left h1 { font-size: 17px; font-weight: 700; }
  .app-header-left p { font-size: 12px; opacity: 0.75; }
  .btn-logout {
    background: rgba(255,255,255,0.15); border: none; color: white;
    padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;
  }
  .tabs {
    background: #0f2554; display: flex; border-top: 1px solid rgba(255,255,255,0.1);
  }
  .tab {
    flex: 1; padding: 12px 6px; text-align: center; color: rgba(255,255,255,0.6);
    cursor: pointer; font-size: 13px; border: none; background: none;
    border-bottom: 3px solid transparent;
  }
  .tab.active { color: white; border-bottom-color: #60a5fa; }
  .content { flex: 1; padding: 16px; max-width: 600px; margin: 0 auto; width: 100%; }

  /* FORMULARIO */
  .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .card h2 { color: #0f2554; font-size: 16px; margin-bottom: 16px; }
  label { display: block; font-size: 13px; color: #374151; font-weight: 600; margin-bottom: 4px; margin-top: 12px; }
  label:first-of-type { margin-top: 0; }
  input[type=text], input[type=password], select, textarea {
    width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb;
    border-radius: 8px; font-size: 14px; outline: none;
    transition: border-color 0.2s; font-family: inherit;
  }
  input:focus, select:focus, textarea:focus { border-color: #0f2554; }
  textarea { resize: vertical; min-height: 70px; }
  .rut-row { display: flex; gap: 8px; }
  .rut-row input { flex: 1; }
  .btn-buscar {
    padding: 10px 16px; background: #0f2554; color: white;
    border: none; border-radius: 8px; cursor: pointer; font-size: 13px; white-space: nowrap;
  }
  .rut-found { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 10px 14px; font-size: 13px; color: #15803d; margin-top: 8px; display: none; }
  .checkbox-row { display: flex; align-items: center; gap: 10px; margin-top: 14px; }
  .checkbox-row input[type=checkbox] { width: 18px; height: 18px; }
  .checkbox-row label { margin: 0; font-weight: 500; }
  #patenteRow { margin-top: 12px; display: none; }
  .btn-submit {
    width: 100%; padding: 14px; background: #0f2554; color: white;
    border: none; border-radius: 10px; font-size: 16px; font-weight: 700;
    cursor: pointer; margin-top: 20px;
  }
  .btn-submit:hover { background: #1a3a7a; }
  .msg-success { background: #f0fdf4; border: 1px solid #86efac; color: #15803d; padding: 12px; border-radius: 8px; text-align: center; font-weight: 600; margin-top: 12px; display: none; }
  .msg-error { background: #fef2f2; border: 1px solid #fca5a5; color: #dc2626; padding: 12px; border-radius: 8px; text-align: center; margin-top: 12px; display: none; }

  /* HISTORIAL */
  .hist-filters { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .hist-filters input[type=text] { flex: 1; min-width: 140px; }
  .hist-filters input[type=date] { flex: 1; min-width: 130px; }
  .btn-clear { padding: 10px 14px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; }
  .btn-excel { padding: 10px 14px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; }
  .stats-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
  .stat-pill { background: #0f2554; color: white; border-radius: 20px; padding: 5px 14px; font-size: 12px; }
  .access-card { background: white; border-radius: 10px; padding: 14px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-left: 4px solid #0f2554; }
  .access-name { font-weight: 700; font-size: 15px; color: #111827; }
  .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 8px; }
  .badge-Visita { background: #dbeafe; color: #1d4ed8; }
  .badge-Delivery { background: #fef3c7; color: #d97706; }
  .badge-Encomienda { background: #d1fae5; color: #065f46; }
  .badge-Otros { background: #ede9fe; color: #7c3aed; }
  .access-meta { font-size: 12px; color: #6b7280; margin-top: 6px; line-height: 1.7; }
  .access-obs { font-size: 12px; color: #374151; margin-top: 6px; padding-top: 6px; border-top: 1px solid #f3f4f6; }
  #histLoading, #regLoading { text-align: center; color: #6b7280; padding: 20px; }

  /* PANEL GUARDIAS */
  .guard-card { background: white; border-radius: 10px; padding: 16px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 14px; }
  .guard-avatar { width: 44px; height: 44px; background: #0f2554; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; flex-shrink: 0; }
  .guard-info { flex: 1; }
  .guard-name { font-weight: 700; color: #111827; }
  .guard-meta { font-size: 12px; color: #6b7280; }
  .guard-count { background: #0f2554; color: white; border-radius: 10px; padding: 4px 12px; font-size: 13px; font-weight: 700; }

  /* ADMIN PANEL */
  #adminScreen { display: none; min-height: 100vh; flex-direction: column; }
  .admin-header {
    background: #7c3aed; color: white; padding: 14px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .admin-header h1 { font-size: 17px; font-weight: 700; }
  .admin-header p { font-size: 12px; opacity: 0.75; }
  .admin-tabs { background: #7c3aed; display: flex; border-top: 1px solid rgba(255,255,255,0.1); }
  .admin-tab { flex: 1; padding: 12px 6px; text-align: center; color: rgba(255,255,255,0.6); cursor: pointer; font-size: 13px; border: none; background: none; border-bottom: 3px solid transparent; }
  .admin-tab.active { color: white; border-bottom-color: #c4b5fd; }
  .admin-content { flex: 1; padding: 16px; max-width: 600px; margin: 0 auto; width: 100%; }
  .btn-purple { background: #7c3aed; color: white; border: none; border-radius: 8px; padding: 10px 18px; cursor: pointer; font-size: 14px; font-weight: 600; }
  .btn-purple:hover { background: #6d28d9; }
  .btn-danger { background: #dc2626; color: white; border: none; border-radius: 8px; padding: 7px 14px; cursor: pointer; font-size: 13px; }
  .btn-success-sm { background: #16a34a; color: white; border: none; border-radius: 8px; padding: 7px 14px; cursor: pointer; font-size: 13px; }
  .btn-warning { background: #d97706; color: white; border: none; border-radius: 8px; padding: 7px 14px; cursor: pointer; font-size: 13px; }
  .guard-admin-card { background: white; border-radius: 10px; padding: 16px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .guard-admin-top { display: flex; align-items: center; justify-content: space-between; }
  .guard-admin-name { font-weight: 700; color: #111827; }
  .guard-admin-meta { font-size: 12px; color: #6b7280; margin-top: 2px; }
  .guard-admin-actions { display: flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; }
  .badge-activo { background: #d1fae5; color: #065f46; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
  .badge-inactivo { background: #fee2e2; color: #991b1b; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
  .form-inline { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .form-inline input { flex: 1; min-width: 120px; }
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 14px; padding: 28px; width: 90%; max-width: 380px; }
  .modal h3 { color: #0f2554; margin-bottom: 18px; font-size: 17px; }
  .modal input, .modal select { width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; margin-bottom: 10px; outline: none; }
  .modal input:focus, .modal select:focus { border-color: #7c3aed; }
  .modal-btns { display: flex; gap: 10px; margin-top: 6px; }
  .modal-btns button { flex: 1; padding: 11px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
  .btn-cancel { background: #e5e7eb; color: #374151; }

  /* FOOTER */
  .app-footer { text-align: center; padding: 14px; color: #9ca3af; font-size: 11px; background: white; border-top: 1px solid #e5e7eb; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- LOGIN GUARDIA -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üè¢</div>
    <div class="login-title">Alto Sacramento 3</div>
    <div class="login-sub">Control de Acceso</div>
    <div class="login-error" id="loginError">Usuario o contrase√±a incorrectos</div>
    <input type="text" id="loginUser" placeholder="Usuario" autocomplete="off">
    <input type="password" id="loginPass" placeholder="Contrase√±a">
    <button class="btn-login" onclick="doLogin()">Ingresar</button>
    <button class="btn-admin-link" onclick="showAdminLogin()">Acceso Administrador</button>
    <div class="login-footer">¬© 2026 Linderos Digital</div>
  </div>
</div>

<!-- LOGIN ADMINISTRADOR -->
<div id="adminLoginScreen" style="display:none;">
  <div class="login-box">
    <div class="login-logo">üîê</div>
    <div class="login-title">Panel Administrador</div>
    <div class="login-sub">Alto Sacramento 3</div>
    <div class="login-error" id="adminLoginError">Usuario o contrase√±a incorrectos</div>
    <input type="text" id="adminLoginUser" placeholder="Usuario admin" autocomplete="off">
    <input type="password" id="adminLoginPass" placeholder="Contrase√±a">
    <button class="btn-login" style="background:#7c3aed;" onclick="doAdminLogin()">Ingresar como Admin</button>
    <button class="btn-admin-link" onclick="showGuardLogin()">‚Üê Volver al login de guardia</button>
    <div class="login-footer">¬© 2026 Linderos Digital</div>
  </div>
</div>

<!-- APP GUARDIA -->
<div id="appScreen" style="display:none; flex-direction:column; min-height:100vh;">
  <div class="app-header">
    <div class="app-header-left">
      <h1>üè¢ Alto Sacramento 3</h1>
      <p id="guardInfo">Guardia ¬∑ Turno</p>
    </div>
    <button class="btn-logout" onclick="doLogout()">Salir</button>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="showTab('registro')">‚ûï Registrar</button>
    <button class="tab" onclick="showTab('historial')">üìã Historial</button>
    <button class="tab" onclick="showTab('guardias')">üëÆ Guardias</button>
  </div>

  <!-- REGISTRO -->
  <div id="tabRegistro" class="content">
    <div class="card">
      <h2>‚ûï Nuevo Registro de Acceso</h2>
      <label>RUT del visitante</label>
      <div class="rut-row">
        <input type="text" id="fRut" placeholder="Ej: 12345678-9" oninput="onRutInput()">
        <button class="btn-buscar" onclick="buscarRut()">Buscar</button>
      </div>
      <div class="rut-found" id="rutFound"></div>
      <label>Nombre</label>
      <input type="text" id="fNombre" placeholder="Nombre del visitante">
      <label>Apellido</label>
      <input type="text" id="fApellido" placeholder="Apellido del visitante">
      <label>Tipo de visita</label>
      <select id="fTipo">
        <option value="">Seleccionar tipo...</option>
        <option value="Visita">Visita</option>
        <option value="Delivery">Delivery</option>
        <option value="Encomienda">Encomienda</option>
        <option value="Otros">Otros</option>
      </select>
      <label>Casa N¬∞</label>
      <input type="text" id="fCasa" placeholder="Ej: 42">
      <div class="checkbox-row">
        <input type="checkbox" id="fVehiculo" onchange="togglePatente()">
        <label for="fVehiculo">Ingresa en veh√≠culo</label>
      </div>
      <div id="patenteRow">
        <label>Patente <span style="color:#ef4444">*</span></label>
        <input type="text" id="fPatente" placeholder="Ej: ABCD12">
      </div>
      <label>Observaci√≥n (opcional)</label>
      <textarea id="fObs" placeholder="Notas adicionales..."></textarea>
      <button class="btn-submit" onclick="submitRegistro()">‚úÖ Registrar Acceso</button>
      <div class="msg-success" id="msgSuccess">¬°Acceso registrado correctamente!</div>
      <div class="msg-error" id="msgError"></div>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div id="tabHistorial" class="content hidden">
    <div class="hist-filters">
      <input type="text" id="filtroTexto" placeholder="üîç Buscar..." oninput="filtrarAccesos()">
      <input type="date" id="filtroFecha" onchange="filtrarAccesos()">
      <button class="btn-clear" onclick="limpiarFiltros()">‚úï</button>
      <button class="btn-excel" onclick="exportarExcel()">üìä Excel</button>
    </div>
    <div class="stats-row" id="statsRow"></div>
    <div id="histLoading">Cargando registros...</div>
    <div id="listaAccesos"></div>
  </div>

  <!-- GUARDIAS -->
  <div id="tabGuardias" class="content hidden">
    <div id="listaGuardias"><div style="text-align:center;color:#6b7280;padding:20px;">Cargando guardias...</div></div>
  </div>

  <div class="app-footer">¬© 2026 Linderos Digital ¬∑ Alto Sacramento 3</div>
</div>

<!-- ADMIN PANEL -->
<div id="adminScreen" style="display:none; flex-direction:column; min-height:100vh;">
  <div class="admin-header">
    <div>
      <h1>üîê Panel Administrador</h1>
      <p id="adminInfo">Alto Sacramento 3</p>
    </div>
    <button class="btn-logout" onclick="doAdminLogout()">Salir</button>
  </div>
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="showAdminTab('guardias')">üëÆ Guardias</button>
    <button class="admin-tab" onclick="showAdminTab('historial')">üìã Historial</button>
    <button class="admin-tab" onclick="showAdminTab('resumen')">üìä Resumen</button>
  </div>

  <!-- ADMIN: GUARDIAS -->
  <div id="adminTabGuardias" class="admin-content">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="color:#7c3aed; margin:0;">Gesti√≥n de Guardias</h2>
        <button class="btn-purple" onclick="openModalCrear()">+ Nuevo Guardia</button>
      </div>
      <div id="adminListaGuardias"><div style="text-align:center;color:#6b7280;padding:20px;">Cargando...</div></div>
    </div>
  </div>

  <!-- ADMIN: HISTORIAL -->
  <div id="adminTabHistorial" class="admin-content hidden">
    <div class="hist-filters">
      <input type="text" id="adminFiltroTexto" placeholder="üîç Buscar..." oninput="filtrarAdmin()">
      <input type="date" id="adminFiltroFecha" onchange="filtrarAdmin()">
      <button class="btn-clear" onclick="limpiarFiltrosAdmin()">‚úï</button>
      <button class="btn-excel" onclick="exportarExcelAdmin()">üìä Excel</button>
    </div>
    <div class="stats-row" id="adminStatsRow"></div>
    <div id="adminHistLoading">Cargando registros...</div>
    <div id="adminListaAccesos"></div>
  </div>

  <!-- ADMIN: RESUMEN -->
  <div id="adminTabResumen" class="admin-content hidden">
    <div id="adminResumen"><div style="text-align:center;color:#6b7280;padding:20px;">Cargando...</div></div>
  </div>

  <div class="app-footer">¬© 2026 Linderos Digital ¬∑ Panel Administrador</div>
</div>

<!-- MODAL CREAR GUARDIA -->
<div class="modal-overlay" id="modalCrear">
  <div class="modal">
    <h3>‚ûï Nuevo Guardia</h3>
    <input type="text" id="mNombre" placeholder="Nombre completo">
    <input type="text" id="mUsername" placeholder="Nombre de usuario">
    <input type="password" id="mPassword" placeholder="Contrase√±a">
    <select id="mTurno">
      <option value="Ma√±ana">Turno Ma√±ana</option>
      <option value="Tarde">Turno Tarde</option>
      <option value="Noche">Turno Noche</option>
    </select>
    <div id="mError" style="color:#ef4444;font-size:13px;display:none;margin-bottom:8px;"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('modalCrear')">Cancelar</button>
      <button class="btn-purple" onclick="crearGuardia()">Crear Guardia</button>
    </div>
  </div>
</div>

<!-- MODAL CAMBIAR CONTRASE√ëA -->
<div class="modal-overlay" id="modalPassword">
  <div class="modal">
    <h3>üîë Cambiar Contrase√±a</h3>
    <p style="font-size:13px;color:#6b7280;margin-bottom:14px;" id="mPassNombre"></p>
    <input type="password" id="mNewPass" placeholder="Nueva contrase√±a">
    <input type="password" id="mNewPass2" placeholder="Confirmar contrase√±a">
    <div id="mPassError" style="color:#ef4444;font-size:13px;display:none;margin-bottom:8px;"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal('modalPassword')">Cancelar</button>
      <button class="btn-purple" onclick="cambiarPassword()">Guardar</button>
    </div>
  </div>
</div>

<script>
const SUPA_URL = 'https://yksfifqdwzntybcnfafq.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrc2ZpZnFkd3pudHliY25mYWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjQ1NTQsImV4cCI6MjA4NzA0MDU1NH0.NBuDK94ZrWrE9v3ers6iSwdD12eiIUbgOGs_Exxxv5w';

var currentGuard = null;
var currentAdmin = null;
var allAccesos = [];
var allAdminAccesos = [];
var allGuardias = [];
var selectedGuardId = null;

function supaFetch(path, opts) {
  var url = SUPA_URL + path;
  var headers = {
    'apikey': SUPA_KEY,
    'Authorization': 'Bearer ' + SUPA_KEY,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation'
  };
  return fetch(url, Object.assign({ headers: headers }, opts || {}));
}

function rpcFetch(fn, body) {
  return supaFetch('/rest/v1/rpc/' + fn, {
    method: 'POST',
    body: JSON.stringify(body)
  });
}

// ===== LOGIN GUARDIA =====
function doLogin() {
  var u = document.getElementById('loginUser').value.trim();
  var p = document.getElementById('loginPass').value.trim();
  document.getElementById('loginError').style.display = 'none';
  if (!u || !p) { document.getElementById('loginError').style.display='block'; return; }

  rpcFetch('verificar_guardia', { p_username: u, p_password: p })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (data && data.length > 0) {
        currentGuard = data[0];
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'flex';
        document.getElementById('guardInfo').textContent = currentGuard.nombre + ' ¬∑ Turno ' + currentGuard.turno;
        cargarHistorial();
        cargarGuardias();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    })
    .catch(function(){ document.getElementById('loginError').style.display='block'; });
}

function doLogout() {
  currentGuard = null;
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}

// ===== LOGIN ADMIN =====
function showAdminLogin() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminLoginScreen').style.display = 'flex';
}

function showGuardLogin() {
  document.getElementById('adminLoginScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function doAdminLogin() {
  var u = document.getElementById('adminLoginUser').value.trim();
  var p = document.getElementById('adminLoginPass').value.trim();
  document.getElementById('adminLoginError').style.display = 'none';
  if (!u || !p) { document.getElementById('adminLoginError').style.display='block'; return; }

  rpcFetch('verificar_administrador', { p_username: u, p_password: p })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (data && data.length > 0) {
        currentAdmin = data[0];
        document.getElementById('adminLoginScreen').style.display = 'none';
        document.getElementById('adminScreen').style.display = 'flex';
        document.getElementById('adminInfo').textContent = 'Admin: ' + currentAdmin.nombre;
        cargarAdminGuardias();
        cargarAdminHistorial();
        cargarAdminResumen();
      } else {
        document.getElementById('adminLoginError').style.display = 'block';
      }
    })
    .catch(function(){ document.getElementById('adminLoginError').style.display='block'; });
}

function doAdminLogout() {
  currentAdmin = null;
  document.getElementById('adminScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('adminLoginUser').value = '';
  document.getElementById('adminLoginPass').value = '';
}

// ===== TABS GUARDIA =====
function showTab(t) {
  ['registro','historial','guardias'].forEach(function(x){
    document.getElementById('tab'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('hidden', x!==t);
  });
  document.querySelectorAll('.tab').forEach(function(b,i){
    b.classList.toggle('active', ['registro','historial','guardias'][i]===t);
  });
}

// ===== TABS ADMIN =====
function showAdminTab(t) {
  ['guardias','historial','resumen'].forEach(function(x){
    document.getElementById('adminTab'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('hidden', x!==t);
  });
  document.querySelectorAll('.admin-tab').forEach(function(b,i){
    b.classList.toggle('active', ['guardias','historial','resumen'][i]===t);
  });
}

// ===== REGISTRO =====
function onRutInput() {
  document.getElementById('rutFound').style.display = 'none';
}

function buscarRut() {
  var rut = document.getElementById('fRut').value.trim();
  if (!rut) return;
  supaFetch('/rest/v1/visitantes?rut=eq.' + encodeURIComponent(rut) + '&select=*')
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (data && data.length > 0) {
        document.getElementById('fNombre').value = data[0].nombre;
        document.getElementById('fApellido').value = data[0].apellido;
        var div = document.getElementById('rutFound');
        div.textContent = '‚úì Visitante encontrado: ' + data[0].nombre + ' ' + data[0].apellido;
        div.style.display = 'block';
      }
    });
}

function togglePatente() {
  var cb = document.getElementById('fVehiculo').checked;
  document.getElementById('patenteRow').style.display = cb ? 'block' : 'none';
  if (!cb) document.getElementById('fPatente').value = '';
}

function submitRegistro() {
  var rut = document.getElementById('fRut').value.trim();
  var nombre = document.getElementById('fNombre').value.trim();
  var apellido = document.getElementById('fApellido').value.trim();
  var tipo = document.getElementById('fTipo').value;
  var casa = document.getElementById('fCasa').value.trim();
  var vehiculo = document.getElementById('fVehiculo').checked;
  var patente = document.getElementById('fPatente').value.trim();
  var obs = document.getElementById('fObs').value.trim();

  var err = document.getElementById('msgError');
  var ok = document.getElementById('msgSuccess');
  err.style.display = 'none'; ok.style.display = 'none';

  if (!rut || !nombre || !apellido || !tipo || !casa) {
    err.textContent = 'Por favor completa todos los campos obligatorios.';
    err.style.display = 'block'; return;
  }
  if (vehiculo && !patente) {
    err.textContent = 'La patente es obligatoria cuando ingresa en veh√≠culo.';
    err.style.display = 'block'; return;
  }

  var btn = document.querySelector('.btn-submit');
  btn.textContent = 'Guardando...'; btn.disabled = true;

  // Guardar visitante
  supaFetch('/rest/v1/visitantes?rut=eq.' + encodeURIComponent(rut) + '&select=*')
    .then(function(r){ return r.json(); })
    .then(function(exists){
      var p;
      if (!exists || exists.length === 0) {
        p = supaFetch('/rest/v1/visitantes', { method: 'POST', body: JSON.stringify({ rut: rut, nombre: nombre, apellido: apellido }) });
      } else {
        p = Promise.resolve();
      }
      return p;
    })
    .then(function(){
      var ahora = new Date();
      var fecha = ahora.getFullYear() + '-' + pad(ahora.getMonth()+1) + '-' + pad(ahora.getDate());
      var hora = pad(ahora.getHours()) + ':' + pad(ahora.getMinutes());
      return supaFetch('/rest/v1/accesos', {
        method: 'POST',
        body: JSON.stringify({
          rut: rut, nombre: nombre, apellido: apellido,
          tipo: tipo, casa: casa,
          vehiculo: vehiculo, patente: vehiculo ? patente : null,
          fecha: fecha, hora: hora,
          guardia_id: currentGuard.id, guardia_nombre: currentGuard.nombre,
          turno: currentGuard.turno, observacion: obs || null
        })
      });
    })
    .then(function(){
      ok.style.display = 'block';
      document.getElementById('fRut').value=''; document.getElementById('fNombre').value='';
      document.getElementById('fApellido').value=''; document.getElementById('fTipo').value='';
      document.getElementById('fCasa').value=''; document.getElementById('fVehiculo').checked=false;
      document.getElementById('fPatente').value=''; document.getElementById('fObs').value='';
      document.getElementById('patenteRow').style.display='none';
      document.getElementById('rutFound').style.display='none';
      btn.textContent='‚úÖ Registrar Acceso'; btn.disabled=false;
      setTimeout(function(){ ok.style.display='none'; }, 3000);
    })
    .catch(function(e){
      err.textContent = 'Error al guardar. Intenta de nuevo.';
      err.style.display='block';
      btn.textContent='‚úÖ Registrar Acceso'; btn.disabled=false;
    });
}

function pad(n){ return n < 10 ? '0'+n : ''+n; }

// ===== HISTORIAL =====
function cargarHistorial() {
  supaFetch('/rest/v1/accesos?select=*&order=created_at.desc&limit=200')
    .then(function(r){ return r.json(); })
    .then(function(data){
      allAccesos = data || [];
      document.getElementById('histLoading').style.display = 'none';
      filtrarAccesos();
    });
}

function filtrarAccesos() {
  var txt = (document.getElementById('filtroTexto').value||'').toLowerCase();
  var fecha = document.getElementById('filtroFecha').value;
  var filtered = allAccesos.filter(function(a){
    var matchTxt = !txt || (a.nombre+' '+a.apellido+' '+a.rut+' '+(a.patente||'')+(a.casa||'')).toLowerCase().includes(txt);
    var matchFecha = !fecha || a.fecha === fecha;
    return matchTxt && matchFecha;
  });
  renderAccesos('listaAccesos', 'statsRow', filtered);
}

function limpiarFiltros() {
  document.getElementById('filtroTexto').value='';
  document.getElementById('filtroFecha').value='';
  filtrarAccesos();
}

function renderAccesos(listId, statsId, data) {
  var total = data.length;
  var visitas = data.filter(function(a){ return a.tipo==='Visita'; }).length;
  var delivery = data.filter(function(a){ return a.tipo==='Delivery'||a.tipo==='Encomienda'; }).length;
  var vehs = data.filter(function(a){ return a.vehiculo; }).length;

  var stats = document.getElementById(statsId);
  if (stats) stats.innerHTML =
    '<span class="stat-pill">Total: '+total+'</span>' +
    '<span class="stat-pill">Visitas: '+visitas+'</span>' +
    '<span class="stat-pill">Delivery/Enc: '+delivery+'</span>' +
    '<span class="stat-pill">Veh√≠culos: '+vehs+'</span>';

  var html = '';
  if (data.length === 0) { html = '<div style="text-align:center;color:#6b7280;padding:24px;">Sin registros</div>'; }
  else {
    data.forEach(function(a){
      var fechaFmt = a.fecha ? a.fecha.split('-').reverse().join('-') : '';
      var hora = a.hora ? a.hora.substring(0,5) : '';
      html += '<div class="access-card">' +
        '<div><span class="access-name">'+a.nombre+' '+a.apellido+'</span>' +
        '<span class="badge badge-'+(a.tipo||'Otros')+'">'+a.tipo+'</span></div>' +
        '<div class="access-meta">' +
        'ü™™ '+a.rut+'  ¬∑  üè† Casa N¬∞ '+a.casa+'<br>' +
        'üìÖ '+fechaFmt+' '+hora +
        (a.vehiculo ? '  üöó '+a.patente : '') + '<br>' +
        'üëÆ '+a.guardia_nombre+' ¬∑ Turno '+a.turno +
        '</div>' +
        '<div class="access-obs">üìù Observaci√≥n: '+(a.observacion||'Sin observaci√≥n')+'</div>' +
        '</div>';
    });
  }
  document.getElementById(listId).innerHTML = html;
}

// ===== GUARDIAS =====
function cargarGuardias() {
  supaFetch('/rest/v1/guardias?select=*&activo=eq.true')
    .then(function(r){ return r.json(); })
    .then(function(data){
      var html = '';
      (data||[]).forEach(function(g){
        var cnt = allAccesos.filter(function(a){ return a.guardia_id===g.id; }).length;
        html += '<div class="guard-card">' +
          '<div class="guard-avatar">üëÆ</div>' +
          '<div class="guard-info"><div class="guard-name">'+g.nombre+'</div>' +
          '<div class="guard-meta">Usuario: '+g.username+' ¬∑ Turno '+g.turno+'</div></div>' +
          '<div class="guard-count">'+cnt+' reg.</div></div>';
      });
      document.getElementById('listaGuardias').innerHTML = html || '<div style="text-align:center;color:#6b7280;padding:20px;">Sin guardias activos</div>';
    });
}

// ===== ADMIN: GUARDIAS =====
function cargarAdminGuardias() {
  supaFetch('/rest/v1/guardias?select=*&order=nombre.asc')
    .then(function(r){ return r.json(); })
    .then(function(data){
      allGuardias = data || [];
      var html = '';
      allGuardias.forEach(function(g){
        html += '<div class="guard-admin-card">' +
          '<div class="guard-admin-top">' +
          '<div><div class="guard-admin-name">'+g.nombre+'</div>' +
          '<div class="guard-admin-meta">Usuario: '+g.username+' ¬∑ Turno '+g.turno+'</div></div>' +
          '<span class="badge-'+(g.activo?'activo':'inactivo')+'">'+(g.activo?'Activo':'Inactivo')+'</span>' +
          '</div>' +
          '<div class="guard-admin-actions">' +
          '<button class="btn-warning" onclick="openModalPassword('+g.id+',\''+g.nombre+'\')">üîë Cambiar Clave</button>' +
          (g.activo
            ? '<button class="btn-danger" onclick="toggleActivo('+g.id+',false)">‚õî Desactivar</button>'
            : '<button class="btn-success-sm" onclick="toggleActivo('+g.id+',true)">‚úÖ Activar</button>') +
          '</div></div>';
      });
      document.getElementById('adminListaGuardias').innerHTML = html || '<p style="color:#6b7280;text-align:center;">Sin guardias</p>';
    });
}

function openModalCrear() {
  document.getElementById('mNombre').value='';
  document.getElementById('mUsername').value='';
  document.getElementById('mPassword').value='';
  document.getElementById('mError').style.display='none';
  document.getElementById('modalCrear').classList.add('open');
}

function crearGuardia() {
  var nombre = document.getElementById('mNombre').value.trim();
  var username = document.getElementById('mUsername').value.trim();
  var password = document.getElementById('mPassword').value.trim();
  var turno = document.getElementById('mTurno').value;
  var err = document.getElementById('mError');
  err.style.display='none';
  if (!nombre||!username||!password) { err.textContent='Completa todos los campos.'; err.style.display='block'; return; }

  rpcFetch('crear_guardia', { p_nombre: nombre, p_username: username, p_password: password, p_turno: turno })
    .then(function(r){
      if (r.ok) { closeModal('modalCrear'); cargarAdminGuardias(); cargarAdminResumen(); }
      else { return r.json().then(function(e){ throw e; }); }
    })
    .catch(function(e){
      err.textContent = (e && e.message) ? e.message : 'Error al crear guardia. El usuario puede ya existir.';
      err.style.display='block';
    });
}

function openModalPassword(id, nombre) {
  selectedGuardId = id;
  document.getElementById('mPassNombre').textContent = 'Guardia: ' + nombre;
  document.getElementById('mNewPass').value='';
  document.getElementById('mNewPass2').value='';
  document.getElementById('mPassError').style.display='none';
  document.getElementById('modalPassword').classList.add('open');
}

function cambiarPassword() {
  var p1 = document.getElementById('mNewPass').value.trim();
  var p2 = document.getElementById('mNewPass2').value.trim();
  var err = document.getElementById('mPassError');
  err.style.display='none';
  if (!p1) { err.textContent='Ingresa una contrase√±a.'; err.style.display='block'; return; }
  if (p1 !== p2) { err.textContent='Las contrase√±as no coinciden.'; err.style.display='block'; return; }

  rpcFetch('cambiar_password_guardia', { p_id: selectedGuardId, p_password: p1 })
    .then(function(r){
      if (r.ok) { closeModal('modalPassword'); }
      else { err.textContent='Error al cambiar contrase√±a.'; err.style.display='block'; }
    });
}

function toggleActivo(id, val) {
  supaFetch('/rest/v1/guardias?id=eq.'+id, {
    method: 'PATCH',
    body: JSON.stringify({ activo: val })
  }).then(function(){ cargarAdminGuardias(); });
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// ===== ADMIN: HISTORIAL =====
function cargarAdminHistorial() {
  supaFetch('/rest/v1/accesos?select=*&order=created_at.desc&limit=500')
    .then(function(r){ return r.json(); })
    .then(function(data){
      allAdminAccesos = data || [];
      document.getElementById('adminHistLoading').style.display = 'none';
      filtrarAdmin();
    });
}

function filtrarAdmin() {
  var txt = (document.getElementById('adminFiltroTexto').value||'').toLowerCase();
  var fecha = document.getElementById('adminFiltroFecha').value;
  var filtered = allAdminAccesos.filter(function(a){
    var matchTxt = !txt || (a.nombre+' '+a.apellido+' '+a.rut+' '+(a.patente||'')+(a.casa||'')).toLowerCase().includes(txt);
    var matchFecha = !fecha || a.fecha === fecha;
    return matchTxt && matchFecha;
  });
  renderAccesos('adminListaAccesos', 'adminStatsRow', filtered);
}

function limpiarFiltrosAdmin() {
  document.getElementById('adminFiltroTexto').value='';
  document.getElementById('adminFiltroFecha').value='';
  filtrarAdmin();
}

// ===== ADMIN: RESUMEN =====
function cargarAdminResumen() {
  supaFetch('/rest/v1/guardias?select=*')
    .then(function(r){ return r.json(); })
    .then(function(guardias){
      return supaFetch('/rest/v1/accesos?select=*&order=created_at.desc&limit=500')
        .then(function(r){ return r.json(); })
        .then(function(accesos){
          var html = '';
          (guardias||[]).forEach(function(g){
            var regs = (accesos||[]).filter(function(a){ return a.guardia_id===g.id; });
            var ultimo = regs.length > 0 ? (regs[0].fecha||'').split('-').reverse().join('-')+' '+regs[0].hora : 'Sin registros';
            html += '<div class="guard-admin-card">' +
              '<div class="guard-admin-top">' +
              '<div><div class="guard-admin-name">'+g.nombre+'</div>' +
              '<div class="guard-admin-meta">Turno: '+g.turno+' ¬∑ Total registros: '+regs.length+'</div>' +
              '<div class="guard-admin-meta">√öltimo registro: '+ultimo+'</div></div>' +
              '<span class="badge-'+(g.activo?'activo':'inactivo')+'">'+(g.activo?'Activo':'Inactivo')+'</span>' +
              '</div></div>';
          });
          document.getElementById('adminResumen').innerHTML = html || '<p style="text-align:center;color:#6b7280;">Sin datos</p>';
        });
    });
}

// ===== EXPORTAR EXCEL =====
function exportarExcel() {
  var txt = (document.getElementById('filtroTexto').value||'').toLowerCase();
  var fecha = document.getElementById('filtroFecha').value;
  var filtered = allAccesos.filter(function(a){
    var matchTxt = !txt || (a.nombre+' '+a.apellido+' '+a.rut+' '+(a.patente||'')+(a.casa||'')).toLowerCase().includes(txt);
    var matchFecha = !fecha || a.fecha === fecha;
    return matchTxt && matchFecha;
  });
  generarCSV(filtered, 'Accesos_AltoSacramento3');
}

function exportarExcelAdmin() {
  var txt = (document.getElementById('adminFiltroTexto').value||'').toLowerCase();
  var fecha = document.getElementById('adminFiltroFecha').value;
  var filtered = allAdminAccesos.filter(function(a){
    var matchTxt = !txt || (a.nombre+' '+a.apellido+' '+a.rut+' '+(a.patente||'')+(a.casa||'')).toLowerCase().includes(txt);
    var matchFecha = !fecha || a.fecha === fecha;
    return matchTxt && matchFecha;
  });
  generarCSV(filtered, 'Accesos_Admin_AltoSacramento3');
}

function generarCSV(data, nombre) {
  var cols = ['Fecha','Hora','Nombre','Apellido','RUT','Tipo','Casa N¬∞','Veh√≠culo','Patente','Guardia','Turno','Observaci√≥n'];
  var rows = data.map(function(a){
    return [
      (a.fecha||'').split('-').reverse().join('-'),
      (a.hora||'').substring(0,5),
      a.nombre||'', a.apellido||'', a.rut||'',
      a.tipo||'', a.casa||'',
      a.vehiculo ? 'S√≠' : 'No',
      a.patente||'', a.guardia_nombre||'', a.turno||'',
      a.observacion||''
    ].map(function(v){ return '"'+String(v).replace(/"/g,'""')+'"'; }).join(',');
  });
  var csv = '\uFEFF' + cols.join(',') + '\n' + rows.join('\n');
  var hoy = new Date(); var d = pad(hoy.getDate())+'-'+pad(hoy.getMonth()+1)+'-'+hoy.getFullYear();
  var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = nombre+'_'+d+'.csv';
  a.click();
}

// Login con Enter
document.addEventListener('keydown', function(e){
  if (e.key === 'Enter') {
    if (document.getElementById('loginScreen').style.display !== 'none') doLogin();
    if (document.getElementById('adminLoginScreen').style.display !== 'none') doAdminLogin();
  }
});
</script>
</body>
</html>
