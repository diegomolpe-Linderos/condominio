<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Control de Acceso - Alto Sacramento 3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f0f4f8;min-height:100vh;display:flex;flex-direction:column;}
input,select,button{font-family:inherit;}
input:disabled{background:#f9fafb;color:#6b7280;}
.hidden{display:none!important;}

#loginScreen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(160deg,#0f2554 0%,#1a3a7a 100%);}
.loginCard{background:#fff;border-radius:20px;padding:40px 36px;width:330px;box-shadow:0 8px 40px rgba(0,0,0,0.25);}
.loginLogo{text-align:center;margin-bottom:20px;}
.loginLogo .icon{font-size:48px;}
.loginLogo h1{font-size:18px;font-weight:800;color:#0f2554;margin-top:8px;}
.loginLogo h2{font-size:13px;font-weight:500;color:#6b7280;margin-top:2px;}
.loginHint{font-size:12px;color:#9ca3af;text-align:center;margin-top:14px;}
.loginBrand{margin-top:28px;text-align:center;font-size:11px;color:rgba(255,255,255,0.5);}
.loginBrand span{color:rgba(255,255,255,0.8);font-weight:600;}

#header{background:linear-gradient(90deg,#0f2554 0%,#1a3a7a 100%);color:#fff;padding:0 20px;}
.headerTop{display:flex;justify-content:space-between;align-items:center;padding:12px 0 8px;}
.headerTitle{font-size:11px;font-weight:600;opacity:0.7;letter-spacing:1px;text-transform:uppercase;}
.headerName{font-size:19px;font-weight:800;}
.headerSub{font-size:12px;opacity:0.75;margin-top:2px;}
#logoutBtn{background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 14px;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;}

#tabs{display:flex;background:#0f2554;}
.tab{flex:1;padding:11px 0;border:none;background:transparent;font-weight:600;font-size:12px;cursor:pointer;color:rgba(255,255,255,0.55);border-bottom:3px solid transparent;transition:all 0.2s;}
.tab.active{color:#fff;border-bottom:3px solid #60a5fa;}

#content{padding:16px;max-width:600px;margin:0 auto;width:100%;flex:1;}
.section{display:none;}
.section.active{display:block;}
h3{color:#0f2554;margin:8px 0 16px;font-size:17px;font-weight:700;}

.card{background:#fff;border-radius:14px;padding:18px;margin-bottom:16px;box-shadow:0 2px 8px rgba(15,37,84,0.08);}

.field{margin-bottom:14px;}
.field label{display:block;font-size:13px;font-weight:600;color:#1e293b;margin-bottom:4px;}
.req{color:#e02424;}
.field input,.field select{width:100%;padding:10px 12px;border:1px solid #dde3f0;border-radius:9px;font-size:15px;outline:none;color:#111827;background:#fff;transition:border 0.2s;}
.field input:focus,.field select:focus{border-color:#0f2554;}
.field input:disabled{background:#f9fafb;color:#6b7280;}
.field input.error-border{border-color:#e02424;}
.field input.ok-border{border-color:#057a55;}
.row{display:flex;gap:12px;}
.row .field{flex:1;}
.check-label{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:14px;font-weight:600;color:#1e293b;}
.check-label input[type=checkbox]{width:18px;height:18px;cursor:pointer;accent-color:#0f2554;}

.btn{padding:10px 20px;border-radius:9px;font-weight:700;font-size:15px;cursor:pointer;border:none;transition:background 0.2s;}
.btn-primary{background:#0f2554;color:#fff;width:100%;margin-top:4px;}
.btn-primary:hover{background:#1a3a7a;}
.btn-primary:disabled{background:#94a3b8;cursor:not-allowed;}

.alert-ok{background:#d1fae5;border:1px solid #057a55;border-radius:8px;padding:12px;margin-bottom:16px;color:#057a55;font-weight:600;display:none;}
.alert-ok.show{display:block;}
.alert-err{color:#e02424;font-size:13px;margin-bottom:10px;display:none;}
.alert-err.show{display:block;}
.found-msg{color:#057a55;font-size:12px;margin-top:4px;display:none;}
.found-msg.show{display:block;}

.search-input{width:100%;padding:10px 12px;border:1px solid #dde3f0;border-radius:9px;font-size:14px;margin-bottom:12px;outline:none;}
.filter-row{display:flex;gap:10px;margin-bottom:16px;}
.filter-row input{flex:1;padding:10px 12px;border:1px solid #dde3f0;border-radius:9px;font-size:14px;outline:none;}
.filter-row input[type=date]{color:#374151;}
.clear-btn{padding:10px 14px;border-radius:9px;border:1px solid #dde3f0;background:#fff;color:#6b7280;font-size:13px;cursor:pointer;}

.log-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(15,37,84,0.07);border-left:4px solid #0f2554;}
.log-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.log-name{font-weight:700;font-size:16px;color:#111827;}
.log-info{font-size:13px;color:#6b7280;line-height:1.9;}
.badge{border-radius:20px;padding:2px 10px;font-size:12px;font-weight:600;}
.badge-visita{background:#dbeafe;color:#1a56db;border:1px solid #93c5fd;}
.badge-comida{background:#fef3c7;color:#d97706;border:1px solid #fcd34d;}
.badge-paquete{background:#d1fae5;color:#057a55;border:1px solid #6ee7b7;}
.badge-otros{background:#ede9fe;color:#7c3aed;border:1px solid #c4b5fd;}
.empty{color:#6b7280;text-align:center;padding:30px 0;font-size:14px;}

.stats-row{display:flex;gap:8px;margin-bottom:16px;}
.stat-pill{flex:1;background:#fff;border-radius:10px;padding:10px 8px;text-align:center;box-shadow:0 2px 6px rgba(15,37,84,0.07);}
.stat-pill .snum{font-size:22px;font-weight:800;color:#0f2554;}
.stat-pill .slbl{font-size:10px;color:#6b7280;margin-top:2px;}

.guard-card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(15,37,84,0.07);}
.guard-top{display:flex;justify-content:space-between;align-items:center;}
.guard-name{font-weight:700;font-size:16px;color:#111827;}
.guard-shift{font-size:13px;color:#6b7280;}
.guard-count .num{font-size:28px;font-weight:800;color:#0f2554;text-align:right;}
.guard-count .lbl{font-size:11px;color:#6b7280;text-align:right;}
.guard-logs{margin-top:10px;border-top:1px solid #f0f4f8;padding-top:10px;}
.guard-log-item{font-size:13px;color:#6b7280;margin-bottom:4px;}
.more{font-size:12px;color:#0f2554;font-weight:600;}

.loading{text-align:center;padding:30px 0;color:#6b7280;font-size:14px;}

#footer{background:#0f2554;color:rgba(255,255,255,0.5);text-align:center;padding:12px 20px;font-size:11px;}
#footer span{color:rgba(255,255,255,0.85);font-weight:700;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="loginCard">
    <div class="loginLogo">
      <div class="icon">ğŸ¢</div>
      <h1>Alto Sacramento 3</h1>
      <h2>Sistema de Control de Acceso</h2>
    </div>
    <div class="field"><label>Usuario</label><input id="loginUser" placeholder="ej: carlos"/></div>
    <div class="field"><label>ContraseÃ±a</label><input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢"/></div>
    <div id="loginErr" class="alert-err"></div>
    <button class="btn btn-primary" id="loginBtn" onclick="doLogin()">Ingresar</button>
    <p class="loginHint">Usuarios: carlos / pedro / luis Â· pass: 1234</p>
  </div>
  <div class="loginBrand">Desarrollado por <span>Linderos Digital</span></div>
</div>

<!-- APP -->
<div id="appScreen" class="hidden" style="display:none;flex-direction:column;min-height:100vh;">
  <div id="header">
    <div class="headerTop">
      <div>
        <div class="headerTitle">Control de Acceso</div>
        <div class="headerName">Alto Sacramento 3</div>
        <div class="headerSub" id="guardInfo"></div>
      </div>
      <button id="logoutBtn" onclick="doLogout()">Salir</button>
    </div>
  </div>
  <div id="tabs">
    <button class="tab active" onclick="switchTab('register',this)">â• Registrar</button>
    <button class="tab" onclick="switchTab('history',this)">ğŸ“‹ Historial</button>
    <button class="tab" onclick="switchTab('guards',this)">ğŸ‘® Guardias</button>
  </div>

  <div id="content">

    <!-- REGISTER -->
    <div id="registerSection" class="section active">
      <h3>Registrar Ingreso</h3>
      <div id="regOk" class="alert-ok">âœ… Visita registrada exitosamente</div>
      <div class="card">
        <div class="field">
          <label>RUT <span class="req">*</span></label>
          <input id="fRut" placeholder="ej: 12345678-9" oninput="handleRut(this)"/>
          <div id="rutFound" class="found-msg">âœ… Visita encontrada en base de datos</div>
        </div>
        <div class="row">
          <div class="field"><label>Nombre <span class="req">*</span></label><input id="fFirst" placeholder="ej: Ana"/></div>
          <div class="field"><label>Apellido <span class="req">*</span></label><input id="fLast" placeholder="ej: GarcÃ­a"/></div>
        </div>
        <div class="field">
          <label>Tipo de visita <span class="req">*</span></label>
          <select id="fType">
            <option value="">-- Seleccionar --</option>
            <option>Visita</option>
            <option>Delivery</option>
            <option>Encomienda</option>
            <option>Otros</option>
          </select>
        </div>
        <div class="field"><label>Casa NÂ° <span class="req">*</span></label><input id="fUnit" placeholder="ej: 15"/></div>
        <div class="field"><label>ObservaciÃ³n</label><input id="fObs" placeholder="ej: Visita autorizada por propietario (opcional)"/></div>
        <div class="field">
          <label class="check-label">
            <input type="checkbox" id="fVehicle" onchange="toggleVehicle()"/>
            Â¿Ingresa en vehÃ­culo?
          </label>
        </div>
        <div class="field hidden" id="plateField">
          <label>Patente del vehÃ­culo <span class="req">*</span></label>
          <input id="fPlate" placeholder="ej: AB-1234 o ABCD12" oninput="this.value=this.value.toUpperCase()"/>
        </div>
        <div id="regErr" class="alert-err"></div>
        <button class="btn btn-primary" id="submitBtn" onclick="submitRegister()">âœ… Registrar Ingreso</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="historySection" class="section">
      <h3>Historial de Accesos</h3>
      <div class="stats-row" id="statsRow"></div>
      <div class="filter-row">
        <input class="search-input" style="margin:0" id="searchInput" placeholder="ğŸ” Nombre, RUT, depto, patente..." oninput="renderHistory()"/>
        <input type="date" id="dateFilter" onchange="renderHistory()"/>
        <button class="clear-btn" onclick="clearFilters()">âœ•</button>
      </div>
      <div id="logList"></div>
    </div>

    <!-- GUARDS -->
    <div id="guardsSection" class="section">
      <h3>Panel de Guardias</h3>
      <div id="guardList"></div>
    </div>

  </div>

  <div id="footer">
    Desarrollado por <span>Linderos Digital</span> &nbsp;Â·&nbsp; Alto Sacramento 3 &copy; 2026
  </div>
</div>

<script>
// â”€â”€ SUPABASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SB_URL = "https://yksfifqdwzntybcnfafq.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlrc2ZpZnFkd3pudHliY25mYWZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjQ1NTQsImV4cCI6MjA4NzA0MDU1NH0.NBuDK94ZrWrE9v3ers6iSwdD12eiIUbgOGs_Exxxv5w";
const HEADERS = { "apikey": SB_KEY, "Authorization": "Bearer " + SB_KEY, "Content-Type": "application/json", "Prefer": "return=representation" };

const api = {
  get: (table, params="") => axios.get(`${SB_URL}/rest/v1/${table}${params}`, { headers: HEADERS }),
  post: (table, data) => axios.post(`${SB_URL}/rest/v1/${table}`, data, { headers: HEADERS }),
};

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentGuard = null;
let allLogs = [];

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const formatRut = v => { const c = v.replace(/[^0-9kK]/g,"").toUpperCase(); if(c.length<=1) return c; return c.slice(0,-1)+"-"+c.slice(-1); };
const nowDT = () => { const d = new Date(); return { date: d.toISOString().slice(0,10), time: d.toTimeString().slice(0,5) }; };
const typeClass = t => t==="Visita"?"badge-visita":t==="Delivery"?"badge-comida":t==="Encomienda"?"badge-paquete":"badge-otros";
const typeBorder = t => t==="Visita"?"#1a56db":t==="Delivery"?"#d97706":t==="Encomienda"?"#057a55":"#7c3aed";
const fmtDate = d => { if(!d) return ""; const [y,m,dd]=d.split("-"); return `${dd}-${m}-${y}`; };

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value;
  const btn = document.getElementById("loginBtn");
  const errEl = document.getElementById("loginErr");
  if(!u||!p){ errEl.textContent="Ingresa usuario y contraseÃ±a."; errEl.classList.add("show"); return; }
  btn.textContent = "Verificando..."; btn.disabled = true;
  try {
    const res = await api.get("guardias", `?username=eq.${u}&password=eq.${p}&activo=eq.true&select=*`);
    if(res.data.length === 0){ errEl.textContent="Usuario o contraseÃ±a incorrectos."; errEl.classList.add("show"); return; }
    errEl.classList.remove("show");
    currentGuard = res.data[0];
    document.getElementById("loginScreen").classList.add("hidden");
    const app = document.getElementById("appScreen");
    app.classList.remove("hidden"); app.style.display = "flex";
    document.getElementById("guardInfo").textContent = "ğŸ‘® " + currentGuard.nombre + " Â· Turno " + currentGuard.turno;
    clearForm();
  } catch(e) {
    errEl.textContent = "Error de conexiÃ³n. Intenta de nuevo."; errEl.classList.add("show");
  } finally {
    btn.textContent = "Ingresar"; btn.disabled = false;
  }
}

function doLogout() {
  currentGuard = null; allLogs = [];
  document.getElementById("loginScreen").classList.remove("hidden");
  const app = document.getElementById("appScreen");
  app.classList.add("hidden"); app.style.display = "none";
  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";
  switchTabByName("register");
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  btn.classList.add("active");
  switchTabByName(name);
}

function switchTabByName(name) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(name+"Section").classList.add("active");
  if(name==="history") { loadLogs(); }
  if(name==="guards")  { loadGuards(); }
}

// â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleRut(input) {
  const rut = formatRut(input.value); input.value = rut;
  const fFirst = document.getElementById("fFirst");
  const fLast  = document.getElementById("fLast");
  const msg    = document.getElementById("rutFound");
  if(rut.length < 4) { fFirst.disabled=false; fLast.disabled=false; input.classList.remove("ok-border"); msg.classList.remove("show"); return; }
  try {
    const res = await api.get("visitantes", `?rut=eq.${encodeURIComponent(rut)}&select=*`);
    if(res.data.length > 0) {
      const v = res.data[0];
      fFirst.value=v.nombre; fFirst.disabled=true;
      fLast.value=v.apellido; fLast.disabled=true;
      input.classList.add("ok-border"); msg.classList.add("show");
    } else {
      fFirst.disabled=false; fLast.disabled=false;
      input.classList.remove("ok-border"); msg.classList.remove("show");
    }
  } catch(e) {}
}

function toggleVehicle() {
  const checked = document.getElementById("fVehicle").checked;
  const pf = document.getElementById("plateField");
  checked ? pf.classList.remove("hidden") : (pf.classList.add("hidden"), document.getElementById("fPlate").value="");
}

function clearForm() {
  ["fRut","fFirst","fLast","fUnit","fPlate","fObs"].forEach(id => document.getElementById(id).value="");
  document.getElementById("fType").value="";
  document.getElementById("fVehicle").checked=false;
  document.getElementById("plateField").classList.add("hidden");
  document.getElementById("fFirst").disabled=false;
  document.getElementById("fLast").disabled=false;
  document.getElementById("fRut").classList.remove("ok-border");
  document.getElementById("rutFound").classList.remove("show");
  document.getElementById("regErr").classList.remove("show");
  document.getElementById("regErr").textContent="";
}

async function submitRegister() {
  const rut       = document.getElementById("fRut").value.trim();
  const firstName = document.getElementById("fFirst").value.trim();
  const lastName  = document.getElementById("fLast").value.trim();
  const type      = document.getElementById("fType").value;
  const unit      = document.getElementById("fUnit").value.trim();
  const vehicle   = document.getElementById("fVehicle").checked;
  const plate     = document.getElementById("fPlate").value.trim();
  const errEl     = document.getElementById("regErr");
  const btn       = document.getElementById("submitBtn");

  let err = "";
  if(!rut||!firstName||!lastName) err="Nombre, apellido y RUT son obligatorios.";
  else if(!type) err="Selecciona el tipo de visita.";
  else if(!unit) err="Ingresa el nÃºmero de casa o departamento.";
  else if(vehicle&&!plate) err="La patente es obligatoria si ingresa en vehÃ­culo.";
  if(err){ errEl.textContent="âš ï¸ "+err; errEl.classList.add("show"); return; }
  errEl.classList.remove("show");

  btn.textContent="Guardando..."; btn.disabled=true;
  const { date, time } = nowDT();
  try {
    // Guardar visitante si no existe
    const vRes = await api.get("visitantes", `?rut=eq.${encodeURIComponent(rut)}&select=id`);
    if(vRes.data.length === 0) {
      await api.post("visitantes", { rut, nombre: firstName, apellido: lastName });
    }
    // Guardar acceso
    await api.post("accesos", {
      rut, nombre: firstName, apellido: lastName, tipo: type,
      unidad: unit, vehiculo: vehicle, patente: plate||null,
      guardia_id: currentGuard.id, guardia_nombre: currentGuard.nombre,
      turno: currentGuard.turno, fecha: date, hora: time
    });
    clearForm();
    const ok = document.getElementById("regOk");
    ok.classList.add("show");
    setTimeout(() => ok.classList.remove("show"), 3000);
  } catch(e) {
    errEl.textContent="âš ï¸ Error al guardar. Intenta de nuevo."; errEl.classList.add("show");
  } finally {
    btn.textContent="âœ… Registrar Ingreso"; btn.disabled=false;
  }
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLogs() {
  document.getElementById("logList").innerHTML='<p class="loading">â³ Cargando registros...</p>';
  try {
    const res = await api.get("accesos", "?select=*&order=created_at.desc");
    allLogs = res.data;
    renderStats();
    renderHistory();
  } catch(e) {
    document.getElementById("logList").innerHTML='<p class="empty">âŒ Error al cargar registros.</p>';
  }
}

function clearFilters() {
  document.getElementById("searchInput").value="";
  document.getElementById("dateFilter").value="";
  renderHistory();
}

function renderStats() {
  const total    = allLogs.length;
  const visitas  = allLogs.filter(l=>l.tipo==="Visita").length;
  const delivery = allLogs.filter(l=>l.tipo!=="Visita").length;
  const vehiculos= allLogs.filter(l=>l.vehiculo).length;
  document.getElementById("statsRow").innerHTML=[
    [total,"Total"],[visitas,"Visitas"],[delivery,"Deliveries"],[vehiculos,"VehÃ­culos"]
  ].map(([n,l])=>`<div class="stat-pill"><div class="snum">${n}</div><div class="slbl">${l}</div></div>`).join("");
}

function renderHistory() {
  const q     = document.getElementById("searchInput").value.toLowerCase();
  const dateF = document.getElementById("dateFilter").value;
  const list  = document.getElementById("logList");
  const filtered = allLogs.filter(l => {
    const matchQ = !q || [l.nombre,l.apellido,l.rut,l.unidad,l.patente||""].join(" ").toLowerCase().includes(q);
    const matchD = !dateF || l.fecha === dateF;
    return matchQ && matchD;
  });
  if(filtered.length===0){ list.innerHTML='<p class="empty">ğŸ“­ Sin resultados para los filtros seleccionados</p>'; return; }
  list.innerHTML = filtered.map(l=>`
    <div class="log-card" style="border-left-color:${typeBorder(l.tipo)}">
      <div class="log-top">
        <span class="log-name">${l.nombre} ${l.apellido}</span>
        <span class="badge ${typeClass(l.tipo)}">${l.tipo}</span>
      </div>
      <div class="log-info">
        ğŸªª ${l.rut} &nbsp;Â·&nbsp; ğŸ  Depto/Casa ${l.unidad}<br/>
        ${l.vehiculo?`ğŸš— Patente: <b style="color:#111827">${l.patente}</b> &nbsp;Â·&nbsp; `:""}
        ğŸ“… ${fmtDate(l.fecha)} ${l.hora}<br/>
        ğŸ‘® ${l.guardia_nombre} Â· Turno ${l.turno}
        ${l.observacion?`<br/>ğŸ“ ObservaciÃ³n: <i style="color:#374151">${l.observacion}</i>`:""}
      </div>
    </div>
  `).join("");
}

// â”€â”€ GUARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGuards() {
  document.getElementById("guardList").innerHTML='<p class="loading">â³ Cargando...</p>';
  try {
    const [gRes, lRes] = await Promise.all([
      api.get("guardias","?select=*&activo=eq.true"),
      api.get("accesos","?select=guardia_id,guardia_nombre,turno,nombre,apellido,unidad,fecha,hora&order=created_at.desc")
    ]);
    const guards = gRes.data;
    const logs   = lRes.data;
    document.getElementById("guardList").innerHTML = guards.map(g => {
      const gl = logs.filter(l => l.guardia_id === g.id);
      const items = gl.slice(0,3).map(l=>`<div class="guard-log-item">â€¢ ${l.nombre} ${l.apellido} â†’ Depto ${l.unidad} Â· ${l.fecha} ${l.hora}</div>`).join("");
      const more  = gl.length>3?`<div class="more">+${gl.length-3} mÃ¡s...</div>`:"";
      return `<div class="guard-card">
        <div class="guard-top">
          <div><div class="guard-name">ğŸ‘® ${g.nombre}</div><div class="guard-shift">${g.turno}</div></div>
          <div class="guard-count"><div class="num">${gl.length}</div><div class="lbl">registros</div></div>
        </div>
        ${gl.length>0?`<div class="guard-logs">${items}${more}</div>`:""}
      </div>`;
    }).join("");
  } catch(e) {
    document.getElementById("guardList").innerHTML='<p class="empty">âŒ Error al cargar guardias.</p>';
  }
}

// â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("loginPass").addEventListener("keydown", e => { if(e.key==="Enter") doLogin(); });
document.getElementById("loginUser").addEventListener("keydown", e => { if(e.key==="Enter") doLogin(); });
</script>
</body>
</html>
